---
title: LVS和负载均衡
layout: post
categories: [技术研究]
tags: [lvs]
description: 网站接入层的一些做法.
---

在大规模互联网应用中，负载均衡设备是必不可少的一个节点，源于互联网应用的高并发和大流量的冲击压力，我们通常会在服务端部署多个无状态的应用服务器和若干有状态的存储服务器（数据库、缓存等等）。  

###负载均衡的作用

负载均衡系统的任务，就是作为应用服务器流量的入口(接入层，接入请求)，然后挑选最合适的一台应用服务器，将客户端请求转发给它处理，实现客户端到真实服务端的透明转发。   

###负载均衡的类型

负载均衡可以采用硬件设备，也可以采用软件负载。  
商用硬件负载设备成本通常较高（一台几十万上百万很正常），所以在条件允许的情况下我们会采用软负载，软负载解决的两个核心问题是：选谁、转发，其中最著名的是LVS。  

###软负载:LVS

1： LVS是四层负载均衡，也就是说它工作在OSI七层网络模型的第四层---传输层，传输层有我们熟悉的TCP/UDP，LVS支持TCP和UDP的负载均衡。  
2： LVS为什么工作是在第四层做负载均衡呢?首先LVS不像HAProxy/nginx等七层软负载面向的是HTTP包，所以七层负载可以做的URL解析等工作，LVS无法完成。其次，某次用户访问是与服务端建立连接后交换数据包实现的，如果在第三层网络层做负载均衡，那么将失去「连接」的语义(IP层是没有连接的)。软负载面向的对象应该是一个已经建立连接的用户，而不是一个孤零零的IP包。后面会看到，实际上LVS的机器代替真实的服务器与用户通过TCP三次握手建立了连接，所以LVS是需要关心「连接」级别的状态的。  
3： LVS的工作模式主要有4种

	1. DR 直接路由转发(调度器与实际服务器都有一块网卡连在同一物理网段上)
	2. NAT 网络地址翻转技术实现虚拟服务器
	3. TUN 	IP隧道技术实现虚拟服务器

最常用的是DR模式。

###DR模式
首先需要给LVS配置一个VIP(虚拟ip，客户端请求的就是这个ip)，请求由LVS接受，由真实提供服务的服务器（RealServer, RS）直接返回给用户，返回的时候不经过LVS。  

DR模式下需要LVS和绑定同一个VIP（RS通过将VIP绑定在loopback实现， loopback本地回路地址）。  
一个请求过来时，LVS只需要将网络帧的MAC地址修改为某一台RS的MAC，该包就会被转发到相应的RS处理，注意此时的源IP和目标IP都没变，LVS只是做了一下移花接木。RS收到LVS转发来的包，链路层发现MAC是自己的，到上面的网络层，发现IP也是自己的，于是这个包被合法地接受，RS感知不到前面有LVS的存在。而当RS返回响应时，只要直接向源IP（即用户的IP）返回即可，不再经过LVS。  

DR模式是性能最好的一种模式。

![img1](https://raw.github.com/yuxingfirst/blog/gh-pages/_images/linux-kernel/lvs-dr.png)

###Session

客户端与服务端的通信，一次请求可能包含多个TCP包，LVS必须保证同一连接的TCP包，必须被转发到同一台RS，否则就乱套了。为了确保这一点，LVS内部维护着一个Session的Hash表，通过客户端的某些信息可以找到应该转发到哪一台RS上。  

###容灾

容灾分为RS的容灾和LVS的容灾。  
RS的容灾可以通过LVS定期健康检测实现，如果某台RS失去心跳，则认为其已经下线，不会在转发到该RS上。  
LVS的容灾可以通过主备+心跳的方式实现。主LVS失去心跳后，备LVS可以作为热备立即替换。  

容灾主要是靠KeepAlived来做的。(keepalive lvs内部的一个组件)