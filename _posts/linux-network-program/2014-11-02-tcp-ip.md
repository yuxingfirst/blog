TCP/IP协议
===

tcp/ip协议是网络编程中使用最广泛的协议，绝对多数应用层协议，如http、ftp等都是构建在tcp/ip协议之上的。不过提起tcp/ip协议，我们除了知道三次握手、四次挥手等这些基础知识外，可能对它们内部的细节原理知之甚少，例如：流量控制、拥塞避免、慢启动、超时重传等。下边我讲为大家介绍下这些知识，帮助自己也帮助大家对tcp/ip协议有一个更全面的了解。  

内容摘要
-------

###1. IP协议  
- 1.1 ip协议格式  
- 1.2 路由寻址
- 1.3 路径MTU

###2. TCP协议
- 2.1 tcp协议格式

###3. TCP连接
- 3.1 连接建立的超时
- 3.2 最大报文段长度(MSS)
- 3.3 TCP半关闭
- 3.4 复位报文段
- 3.5 同时打开
- 3.6 同时关闭

###4. TCP ACK
- 4.1 经受时延ACK
- 4.2 Nagle算法
- 4.3 窗口大小通告

###5. TCP超时与重传
- 5.1 超时重传示例
- 5.2 往返时间(RTT)测量
- 5.3 拥塞
- 5.3 拥塞避免算法
- 5.4 快速重传与快速恢复

一、IP协议
-----

IP是TCP/IP协议族中最为核心的协议。所有TCP、UDP、ICMP和IGMP数据都是以IP数据报的形式传输的。我们知道在TCP/IP协议族中，通常将网络分为四层：  

	应用层
	传输层
	网络层
	数据链路层   

IP则属于网络层协议，其他的TCP、UDP等属于传输层协议，而我们熟知的HTTP等则属于应用层协议。IP协议提供不可靠、无连接的数据报传送服务，许多人可能会对此感到疑惑，不可靠、无连接具体意味着什么呢?  
	
不可靠（unreliable）的意思是它不保证IP数据报能成功到达目的地，IP仅提供传输服务。如果发生某种错误，如某个中间路由器的缓冲区用完了，IP的处理方式为：丢弃该数据报，然后发送ICMP消息报给信息源端。任何要求的可靠性必须由上层来提供（如TCP）。

无连接（connectionless）意思是每个数据报的处理都是独立的，IP数据报可以不按顺序接受。如果信息源向相同的目的地放松两个连续的数据报，每个数据报都是独立的进行路由选择，可能选择不同的线路，所以不保证数据报的达到顺序。

#####1.1 IP协议格式

![IP协议格式][1]

可以看到，IP协议格式最高位在左边，极为0bit； 最低位在右边，记为31bit。由于TCP/IP首部中的所有二进制整数在网络传输时都要求从高位到低位传输，因此这种传输次序称作大端（big endian）字节序（也称作网络字节序）。所以通常我们在传输数据之前要把首部转换成网络字节序。  

我们看到，IP协议中有个2字节的总长度字段，所以IP数据报的最大长度为：65535字节（包括IP首部）。不过这并不意味这一个IP数据报可以长达65535字节， -- todo MTU  

TTL（8位生成时间）设置了数据报最多可以经过的路由器的个数，它指定了数据报的生存时间。TTL的初始值由源主机设置（通常为32或64），一旦经过一个处理它的路由器，他的值就减去1。当该字段为0时，数据报被丢弃，并发送一个IGMP信息通知源主机。 


#####1.2 路由寻址  

IP路由选择是简单的。如果目的主机与源主机直接相连（如点对点网络）或者在同一个共享网络上（以太网或令牌环网），那么IP数据报就直接送到目的主机上。否则，主机就把数据报发往一默认的路由器上，由路由器来转发该数据报。


-EOF-

[1]: https://raw.githubusercontent.com/yuxingfirst/blog/gh-pages/_images/linux-network-program/ip-protocol-format.png  