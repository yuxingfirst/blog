---
title: IP分片
layout: post
categories: [网络编程]
tags: [network]
description: ip分片.
---

###1.为什么要分片

物理网络层一般要限制每次发送数据帧的最大长度。任何时候IP层接受到一份要发送的IP数据报时，它要判断向本地哪个接口发送数据(选路)，并查询该接口获得其MTU(最大传输单元)，常见以太网的MTU为1500字节。IP把MTU与数据报长度进行对比，如果需要则进行分片。***分片可以发生在原始发送端主机上，也可以发生在中间路由器上***。  

把一份IP数据报分片以后，只有到达目的地才进行重新组装（这里的重新组装于其他网络协议不同，它们要求在下一站就进行重新组装，而不是在最终的目的地）。重新组装有目的段的IP层来完成，其目的是使分片和重新组装过程跟传输层（TCP和UDP）是透明的，以及防止某些可能的性能降低。已经分片过的数据报有可能会再次进行分片（可能不止一次）。IP首部中包含的数据为分片和组装提供了足够的信息。  

###2. IP协议

首先，我们看下IP协议首部：  

	 0                  1                   2                    3   
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 
   	+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ 
   	|Version|  IHL  |Type of Service|          Total Length         |
   	+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   	|         Identification        |Flags|      Fragment Offset    |
   	+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   	|  Time to Live |    Protocol   |         Header Checksum       | 
   	+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   	|                       Source Address                          |
   	+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   	|                    Destination Address                        |
   	+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ 
   	|                    Options                    |    Padding    |
   	+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
	/					 		Data								/
	+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

	Version				: 4位版本号(IpV4, IpV6)
	IHL					: 4位首部长度
	Type of Service 	: 8位服务类型
	Total Length		: 16位总长度
	Identification		: 16位标识
	Flags				: 3位，不同的控制标记
							Bit 0: 保留
							Bit 1: (DF) 0=可以分片(May Fragment), 1=不可分片(Don't Fragment)
							Bit 2: (MF) 0=最后一个分片(Last Fragment)，1=还有分片(More Fragment)

	Fragment Offset		: 分片偏移(指示了这个分片在所属数据报中的位置，分片偏移已8字节[64位]做为计量单位，第一个分片偏移为0)	

	Time to Live		: 8为生存时间
							该头部指示了数据报允许在internet系统中生存的最大时间.如果该头部的值为0,数据报必须被销毁.该头部在
							internet头部处理的时候被改变,该时间以秒单位度量,但由于处理数据报的每个模块必须减少TTL至少1秒,即便
							该模块处理数据报的时间少于1秒,TTL必须被视为数据报可以存在的时间的上限.这样做的目的是丢弃无法投递的
							数据报,限制数据报的生存时间

	Protocol			: 8位协议(指明数据报的数据部分使用的下一个层次的协议， tcp/udp/icmp/igmp)
							当目的主机收到一个以太网数据帧时，数据帧就开始从协议栈中由底向上升，同时去掉各层协议加上的报文首部。
							每层协议盒都要去检查报文首部冲的协议标识，已确定接受数据的上层协议(这个过程称为分用)

	Header Checksum		: 16位头部校验和
	Source Address		: 32位源地址
	Destination Address : 32位目的地址

从上边的IP首部结构可以看出，一般IP首部长为20字节，除非含有选项字段。  

###3. 分片原理

对于发送端发送的每份IP数据报来说，标识字段(Identification)都包含有一个唯一值。这个值在数据报分片时被复制到每个分片中。标志字段(Flags)用其中一个bit(Flags中的DM位)来表示"更多的片"；除了最后一片外，其他每个组成数据报的片都要把该bit位置为1。此外，当数据报被分片后，每个片的总长度值要改为改片的长度值。  

另外，Flags中的DF位用来标识数据报是否可以进行分片。如果一份数据报要进行分片而这个位被设置为1，则IP层把数据报丢弃并发送一个ICMP差错报文给起始端。  

当IP数据报被分片后，每一片都成为一个分组，具有自己的IP首部，并在选择路由时与其他分组独立。这样，当数据报的这些片到达目的端时有可能会失序，但是在IP首部中有足够的信息让接收端能正确的组装这些数据报片。  

尽管IP分片过程看起来是透明的，但有一点让人不想使用它：即使只丢失了一片数据也要重传整个数据报。为什么呢？因为IP层本身没有超时重传的机制--由更高层来负责超时和重传（TCP有超时和重传机制，但UDP没有）。当来自TCP报文的某一片丢失后，TCP在超时后会重发整个TCP报文段，该报文段对应于一份IP数据报。没有办法只重传数据报中的一个数据报片。因为，***如果对数据报分片的是中间路由器，而不是起始端系统，那么起始端系统就无法知道数据报是如何被分片的***。所以，对于TCP来说，它是尽量避免分片的。  

在分片时，除最后一片外，其他每一片中的数据部分(除IP首部外的其余部分)， 必须是8字节的整数倍。特殊的是，***任何传输层的首部只出现在第一片数据中***。  

需要解释的几个术语：
	
	IP数据报	->	指IP层端到端的传输单元(在分片之前和重新组装之后)
	分组		->	IP层和链路层(网络接口)之间传送的数据单元
	
	所以，一个分组可以是一个完整的IP数据报也可以是IP数据报的一个分片


-EOF-
