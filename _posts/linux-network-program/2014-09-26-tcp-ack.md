---
title: TCP ACK机制分析
layout: post
categories: [网络编程]
tags: [network]
description: tcp ack.
---  

###1. 为什么要ACK  
我们知道，TCP是一种可靠的数据传输协议，那么为什么说它是可靠的呢? TCP的可靠性又是靠什么来保证的呢? 其中最重要的一个特性就是TCP的数据确认应答机制， 即是说接收方每收到一个数据包，都会向发送方发送一个应答，即ACK。    

我们知道， 在TCP首部中，有一个32位的确认号字段，这个字段实际上是指接收端希望接受的下一个字节的序列号。所以接收端在成功接受到部分数据后，其发送的应答数据包中的应答序列号(确认号)被设置为这些数据包中最后一个字节的序列号加1。  
  
同时，TCP首部中的32位序列号字段表示包含该TCP首部的数据包中所包含数据的第一个字节的序列号(设为N)。如果接收端成功接受到该数据包， 之前又没有丢失数据包，则接收端发送的应答数据包中的应答序列号应该为： ***N+LEN***(LEN为接受的数据包的***数据长度***)。 该序列号也是发送端将要发送的下一个数据包中第一个字节的序列号。  
  
其次，需要注意的一点是，接收端在发送应答的时候不可跨越式应答，什么意思呢？ 举个列子：  

发送端发送了2个数据包，第一个数据包A中数据的序列号的范围是201 ~ 300， 第二个数据包B中数据的序列号范围是301 ~ 400， 并且接收端上一次发送应答的应答序列号是201。 由于网络原因， 数据包B先到达了，数据包A还在网络中，此时，接收端是不会对数据包B进行确认的。而是会不断发送应答序列号为201的应答数据包直到该序列号的包到达。  

我们通常所说的快速重传机制即发送端在连续接收到3个相同序列号的应答数据包后需要立刻重传应答序列号所表示的数据。因为此时表示极有可能出现了数据包丢失的情况，发送端需要重传序列号为201开始的数据包。


###2. 什么是Delay ACK(经受时延的ACK)
通常，TCP在接受到数据时并不立即发送ACK； 相反，它推迟发送以便将ACK于需要沿该方向发送的数据一起发送(有时称这种现象为数据捎带ACK)。   

绝大多数实现采用的时延为200ms，也就是说，TCP将以最大200ms的时延等待是否有数据一起发送。  

###3. Nagle算法  
在某些应用程序中，可能存在每次都发送一个字节到服务器的情况（Rlogin），这就产生了一些41字节长的分组：20字节的IP首部、20字节的TCP首部和一个字节的数据。在局域网上，这些小分组通常不会引起麻烦，因为局域网一般不会出现拥塞。但在广域网上，这些小分组则会增加拥塞出现的可能。 一种简单和好的方法就是采用Nagle算法。  

Nagle算法***要求一个TCP连接上最多只能有一个未被确认的未完成的小分组，在该分组的确认到达之前不能发送其他的小分组***。相反，TCP收集这些少量的分组，并在确认到来时以一个分组的方式发送出去。该算法的优越指出在于它是自适应的：确认到达的越快，数据也就发送的越快。而在希望减少微笑分组数目的广域网上，则会发送更少的分组。

-EOF-
